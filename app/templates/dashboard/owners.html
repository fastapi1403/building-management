{% extends "base.html" %}

{% block title %}Owners Management - Building Management System{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Owners</li>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
        <h1 class="h2">Owners Management</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="exportOwners('excel')">
                    <i class="fas fa-file-excel"></i> Export
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="printOwnersList()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
            <button type="button" class="btn btn-primary" onclick="showAddOwnerModal()">
                <i class="fas fa-plus"></i> Add New Owner
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Owners</h5>
                    <h2 class="card-text">{{ stats.total_owners }}</h2>
                    <small>Active owners in the system</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Units Owned</h5>
                    <h2 class="card-text">{{ stats.total_units }}</h2>
                    <small>Units under ownership</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Pending Charges</h5>
                    <h2 class="card-text">${{ stats.pending_charges|format_currency }}</h2>
                    <small>Total pending payments</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Average Units/Owner</h5>
                    <h2 class="card-text">{{ stats.avg_units_per_owner }}</h2>
                    <small>Units per owner ratio</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="card">
        <div class="card-body">
            <!-- Filters -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchOwner" placeholder="Search owners...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="buildingFilter">
                        <option value="">All Buildings</option>
                        {% for building in buildings %}
                        <option value="{{ building.id }}">{{ building.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>

            <!-- Owners Table -->
            <div class="table-responsive">
                <table class="table table-hover" id="ownersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Units Owned</th>
                            <th>Total Balance</th>
                            <th>Last Payment</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for owner in owners %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle">
                                        {{ owner.name|initials }}
                                    </div>
                                    <div class="ms-2">
                                        <div>{{ owner.name }}</div>
                                        <small class="text-muted">ID: {{ owner.national_id }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>{{ owner.phone }}</div>
                                <small class="text-muted">{{ owner.email }}</small>
                            </td>
                            <td>
                                <div class="badge bg-info">{{ owner.units|length }} units</div>
                            </td>
                            <td>${{ owner.total_balance|format_currency }}</td>
                            <td>{{ owner.last_payment_date|time_ago if owner.last_payment_date else 'No payments' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if owner.is_active else 'danger' }}">
                                    {{ 'Active' if owner.is_active else 'Inactive' }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-primary" onclick="editOwner({{ owner.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="viewOwnerDetails({{ owner.id }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteOwner({{ owner.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Owner Modal -->
<div class="modal fade" id="ownerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ownerModalTitle">Add New Owner</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="ownerForm" onsubmit="return handleOwnerSubmit(event)">
                <div class="modal-body">
                    <input type="hidden" id="ownerId" name="id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">National ID</label>
                            <input type="text" class="form-control" id="national_id" name="national_id" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone" name="phone" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">WhatsApp</label>
                            <input type="tel" class="form-control" id="whatsapp" name="whatsapp">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Telegram</label>
                            <input type="text" class="form-control" id="telegram" name="telegram">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Owner</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Owner Details Modal -->
<div class="modal fade" id="ownerDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Owner Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ownerDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.avatar-circle {
    width: 40px;
    height: 40px;
    background-color: #007bff;
    border-radius: 50%;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.stat-card {
    padding: 10px;
    border-radius: 5px;
    background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeDataTable();
    initializeOwnerCharts();
    setupEventListeners();
});

// Initialize DataTable with advanced features
function initializeDataTable() {
    $('#ownersTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/api/v1/owners/datatable',
            type: 'POST',
            data: function(d) {
                return {
                    ...d,
                    status: $('#statusFilter').val(),
                    property_type: $('#propertyTypeFilter').val()
                };
            }
        },
        columns: [
            {
                data: null,
                render: function(data) {
                    return `
                        <div class="d-flex align-items-center">
                            <img src="${data.avatar_url || '/static/img/default-avatar.png'}"
                                 class="rounded-circle me-2"
                                 width="40" height="40">
                            <div>
                                <div class="fw-bold">${data.name}</div>
                                <small class="text-muted">${data.email}</small>
                            </div>
                        </div>
                    `;
                }
            },
            { data: 'phone' },
            {
                data: 'units_owned',
                render: function(data) {
                    return `<span class="badge bg-primary">${data.length}</span>`;
                }
            },
            {
                data: 'total_area_owned',
                render: function(data) {
                    return `${data} m²`;
                }
            },
            {
                data: 'payment_status',
                render: function(data) {
                    const statusClasses = {
                        'paid': 'success',
                        'partial': 'warning',
                        'overdue': 'danger'
                    };
                    return `<span class="badge bg-${statusClasses[data]}">${data}</span>`;
                }
            },
            {
                data: null,
                render: function(data) {
                    return `
                        <div class="btn-group">
                            <button class="btn btn-sm btn-primary" onclick="editOwner(${data.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-info" onclick="viewOwnerDetails(${data.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="showPaymentHistory(${data.id})">
                                <i class="fas fa-money-bill"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteOwner(${data.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        order: [[0, 'asc']],
        responsive: true,
        dom: 'Bfrtip',
        buttons: [
            'copy', 'csv', 'excel', 'pdf', 'print'
        ]
    });
}

// Initialize Charts
function initializeOwnerCharts() {
    // Property Distribution Chart
    const propertyCtx = document.getElementById('propertyDistributionChart').getContext('2d');
    new Chart(propertyCtx, {
        type: 'doughnut',
        data: propertyDistributionData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Payment Status Chart
    const paymentCtx = document.getElementById('paymentStatusChart').getContext('2d');
    new Chart(paymentCtx, {
        type: 'bar',
        data: paymentStatusData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Event Listeners Setup
function setupEventListeners() {
    // Owner Form Submit
    document.getElementById('ownerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleOwnerSubmit(e);
    });

    // Filters
    document.querySelectorAll('.filter-select').forEach(filter => {
        filter.addEventListener('change', () => {
            $('#ownersTable').DataTable().ajax.reload();
        });
    });
}

// CRUD Operations
async function handleOwnerSubmit(event) {
    const form = event.target;
    const formData = new FormData(form);
    const ownerId = document.getElementById('ownerId').value;

    try {
        const response = await fetch(`/api/v1/owners/${ownerId || ''}`, {
            method: ownerId ? 'PUT' : 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(Object.fromEntries(formData)),
        });

        if (response.ok) {
            showToast('Success', 'Owner saved successfully', 'success');
            $('#ownerModal').modal('hide');
            $('#ownersTable').DataTable().ajax.reload();
        } else {
            const error = await response.json();
            showToast('Error', error.detail, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'An error occurred while saving', 'error');
    }
}

async function editOwner(ownerId) {
    try {
        const response = await fetch(`/api/v1/owners/${ownerId}`);
        const owner = await response.json();

        // Populate form
        Object.keys(owner).forEach(key => {
            const element = document.getElementById(key);
            if (element) element.value = owner[key];
        });

        document.getElementById('ownerModalTitle').textContent = 'Edit Owner';
        $('#ownerModal').modal('show');
    } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'Error loading owner data', 'error');
    }
}

async function deleteOwner(ownerId) {
    if (await confirmDialog('Are you sure you want to delete this owner?')) {
        try {
            const response = await fetch(`/api/v1/owners/${ownerId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('Success', 'Owner deleted successfully', 'success');
                $('#ownersTable').DataTable().ajax.reload();
            } else {
                throw new Error('Failed to delete owner');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error', 'Error deleting owner', 'error');
        }
    }
}

async function viewOwnerDetails(ownerId) {
    try {
        const response = await fetch(`/api/v1/owners/${ownerId}/details`);
        const details = await response.json();

        // Update details modal content
        document.getElementById('ownerDetailsContent').innerHTML = generateOwnerDetailsHTML(details);
        $('#ownerDetailsModal').modal('show');
    } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'Error loading owner details', 'error');
    }
}

async function showPaymentHistory(ownerId) {
    try {
        const response = await fetch(`/api/v1/owners/${ownerId}/payments`);
        const payments = await response.json();

        // Update payment history modal
        document.getElementById('paymentHistoryContent').innerHTML = generatePaymentHistoryHTML(payments);
        $('#paymentHistoryModal').modal('show');
    } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'Error loading payment history', 'error');
    }
}

// Utility Functions
function showToast(title, message, type) {
    Toastify({
        text: message,
        duration: 3000,
        gravity: 'top',
        position: 'right',
        backgroundColor: type === 'success' ? '#28a745' : '#dc3545'
    }).showToast();
}

async function confirmDialog(message) {
    return await Swal.fire({
        title: 'Confirm Action',
        text: message,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, proceed!'
    }).then((result) => result.isConfirmed);
}

function generateOwnerDetailsHTML(details) {
    return `
        <div class="row">
            <div class="col-md-6">
                <h5>Personal Information</h5>
                <p><strong>Name:</strong> ${details.name}</p>
                <p><strong>Email:</strong> ${details.email}</p>
                <p><strong>Phone:</strong> ${details.phone}</p>
                <p><strong>Address:</strong> ${details.address}</p>
            </div>
            <div class="col-md-6">
                <h5>Property Information</h5>
                <p><strong>Total Units:</strong> ${details.units_owned.length}</p>
                <p><strong>Total Area:</strong> ${details.total_area_owned} m²</p>
                <p><strong>Total Value:</strong> $${details.total_property_value}</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h5>Owned Units</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Unit</th>
                                <th>Building</th>
                                <th>Floor</th>
                                <th>Area</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${details.units_owned.map(unit => `
                                <tr>
                                    <td>${unit.unit_number}</td>
                                    <td>${unit.building_name}</td>
                                    <td>${unit.floor_number}</td>
                                    <td>${unit.area} m²</td>
                                    <td>
                                        <span class="badge bg-${unit.is_occupied ? 'success' : 'danger'}">
                                            ${unit.is_occupied ? 'Occupied' : 'Vacant'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function generatePaymentHistoryHTML(payments) {
    return `
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Reference</th>
                    </tr>
                </thead>
                <tbody>
                    ${payments.map(payment => `
                        <tr>
                            <td>${new Date(payment.date).toLocaleDateString()}</td>
                            <td>$${payment.amount}</td>
                            <td>${payment.type}</td>
                            <td>
                                <span class="badge bg-${payment.status === 'paid' ? 'success' : 'warning'}">
                                    ${payment.status}
                                </span>
                            </td>
                            <td>${payment.reference}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}
</script>
{% endblock %}