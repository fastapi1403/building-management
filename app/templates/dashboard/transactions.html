{% extends "base.html" %}

{% block title %}Transactions Management - Building Management System{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Transactions</li>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
        <h1 class="h2">Transactions Management</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-primary me-2" id="addTransactionBtn">
                <i class="fas fa-plus"></i> New Transaction
            </button>
            <div class="btn-group me-2">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download"></i> Export
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportTransactions('pdf')">PDF</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportTransactions('excel')">Excel</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportTransactions('csv')">CSV</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <h5 class="card-title">Total Transactions</h5>
                    <h2 class="card-text" id="totalTransactions">{{ stats.total_transactions }}</h2>
                    <small>Last 30 days</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <h5 class="card-title">Total Income</h5>
                    <h2 class="card-text" id="totalIncome">${{ stats.total_income|format_currency }}</h2>
                    <small>Last 30 days</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white h-100">
                <div class="card-body">
                    <h5 class="card-title">Total Expenses</h5>
                    <h2 class="card-text" id="totalExpenses">${{ stats.total_expenses|format_currency }}</h2>
                    <small>Last 30 days</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body">
                    <h5 class="card-title">Pending Transactions</h5>
                    <h2 class="card-text" id="pendingTransactions">{{ stats.pending_transactions }}</h2>
                    <small>Requires attention</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="form-group">
                <label for="dateRange">Date Range</label>
                <input type="text" class="form-control" id="dateRange">
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label for="typeFilter">Type</label>
                <select class="form-select filter-select" id="typeFilter">
                    <option value="">All Types</option>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </select>
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label for="categoryFilter">Category</label>
                <select class="form-select filter-select" id="categoryFilter">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label for="statusFilter">Status</label>
                <select class="form-select filter-select" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label for="searchTransaction">Search</label>
                <input type="text" class="form-control" id="searchTransaction" placeholder="Search transactions...">
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Monthly Transaction Overview</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyOverviewChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Transaction Categories</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoriesChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Transaction List</h5>
        </div>
        <div class="card-body">
            <table id="transactionsTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Reference</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<!-- Transaction Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalTitle">Add New Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="transactionForm" onsubmit="return handleTransactionSubmit(event)">
                <div class="modal-body">
                    <div class="row g-3">
                        <input type="hidden" id="transactionId" name="id">
                        
                        <div class="col-md-6">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="transactionDate" name="date" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Reference</label>
                            <input type="text" class="form-control" id="reference" name="reference" required>
                        </div>
                        
                        <div class="col-md-12">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" id="description" name="description" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="type" name="type" required>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="category" name="category_id" required>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="amount" name="amount" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="completed">Completed</option>
                                <option value="pending">Pending</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                        
                        <div class="col-md-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transaction Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="transactionDetailsContent">
                <!-- Content will be dynamically loaded -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeTransactionsTable();
    initializeCharts();
    setupDatePickers();
    setupEventListeners();
});

// Initialize DataTable for transactions
function initializeTransactionsTable() {
    window.transactionsTable = $('#transactionsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/api/v1/transactions',
            type: 'POST',
            data: function(d) {
                return {
                    ...d,
                    startDate: $('#startDate').val(),
                    endDate: $('#endDate').val(),
                    transactionType: $('#typeFilter').val(),
                    status: $('#statusFilter').val(),
                    category: $('#categoryFilter').val(),
                    paymentMethod: $('#paymentMethodFilter').val()
                };
            }
        },
        columns: [
            {
                data: 'created_at',
                render: function(data) {
                    return moment.utc(data).local().format('DD/MM/YYYY HH:mm');
                }
            },
            { data: 'transaction_id' },
            { data: 'description' },
            {
                data: 'amount',
                render: function(data, type, row) {
                    const amount = parseFloat(data);
                    const color = row.type === 'credit' ? 'text-success' : 'text-danger';
                    return `<span class="${color}">
                        ${row.type === 'credit' ? '+' : '-'}
                        ${amount.toLocaleString('en-US', {
                            style: 'currency',
                            currency: 'USD'
                        })}
                    </span>`;
                }
            },
            {
                data: 'category',
                render: function(data) {
                    return `<span class="badge bg-info">${data}</span>`;
                }
            },
            { data: 'payment_method' },
            {
                data: 'status',
                render: function(data) {
                    const statusColors = {
                        'pending': 'bg-warning',
                        'completed': 'bg-success',
                        'failed': 'bg-danger',
                        'cancelled': 'bg-secondary',
                        'refunded': 'bg-info'
                    };
                    return `<span class="badge ${statusColors[data] || 'bg-secondary'}">${data}</span>`;
                }
            },
            {
                data: null,
                orderable: false,
                render: function(data, type, row) {
                    const canEdit = row.status !== 'completed' && row.created_by === '{{ current_user.username }}';
                    return `
                        <div class="btn-group">
                            <button class="btn btn-sm btn-info" onclick="viewTransaction(${row.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${canEdit ? `
                                <button class="btn btn-sm btn-primary" onclick="editTransaction(${row.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="cancelTransaction(${row.id})" title="Cancel">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="downloadReceipt(${row.id})" title="Download Receipt">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        order: [[0, 'desc']],
        responsive: true,
        dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center"l><"d-flex"f>>rtip',
        buttons: [
            {
                extend: 'collection',
                text: '<i class="fas fa-download"></i> Export',
                buttons: ['csv', 'excel', 'pdf']
            }
        ],
        pageLength: 25,
        language: {
            search: "Quick Search:",
            lengthMenu: "Show _MENU_ transactions",
            processing: '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>'
        }
    });
}

// Initialize Transaction Charts
function initializeCharts() {
    // Daily Transaction Volume Chart
    const dailyCtx = document.getElementById('dailyTransactionsChart').getContext('2d');
    fetch('/api/v1/transactions/daily-volume')
        .then(response => response.json())
        .then(data => {
            new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Credits',
                        data: data.credits,
                        borderColor: '#28a745',
                        fill: false
                    }, {
                        label: 'Debits',
                        data: data.debits,
                        borderColor: '#dc3545',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '$' + value.toLocaleString()
                            }
                        }
                    }
                }
            });
        });

    // Category Distribution Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    fetch('/api/v1/transactions/category-summary')
        .then(response => response.json())
        .then(data => {
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: data.categories,
                    datasets: [{
                        data: data.amounts,
                        backgroundColor: [
                            '#28a745', '#007bff', '#ffc107', '#dc3545',
                            '#17a2b8', '#6610f2', '#fd7e14', '#20c997'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        });
}

// Setup Date Pickers
function setupDatePickers() {
    $('#dateRange').daterangepicker({
        startDate: moment().subtract(30, 'days'),
        endDate: moment(),
        ranges: {
            'Today': [moment(), moment()],
            'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
            'Last 7 Days': [moment().subtract(6, 'days'), moment()],
            'Last 30 Days': [moment().subtract(29, 'days'), moment()],
            'This Month': [moment().startOf('month'), moment().endOf('month')],
            'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
    }, function(start, end) {
        $('#startDate').val(start.format('YYYY-MM-DD'));
        $('#endDate').val(end.format('YYYY-MM-DD'));
        window.transactionsTable.ajax.reload();
    });
}

// Transaction Operations
async function handleTransactionSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const transactionId = document.getElementById('transactionId').value;

    try {
        const response = await fetch(`/api/v1/transactions/${transactionId || ''}`, {
            method: transactionId ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(Object.fromEntries(formData))
        });

        if (response.ok) {
            $('#transactionModal').modal('hide');
            window.transactionsTable.ajax.reload();
            showToast('Success', 'Transaction saved successfully', 'success');
        } else {
            const error = await response.json();
            showToast('Error', error.message, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'Failed to save transaction', 'error');
    }
}

async function viewTransaction(id) {
    try {
        const response = await fetch(`/api/v1/transactions/${id}`);
        const transaction = await response.json();

        const detailsHtml = `
            <div class="transaction-details">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Transaction ID:</strong> ${transaction.transaction_id}</p>
                        <p><strong>Date:</strong> ${moment(transaction.created_at).format('DD/MM/YYYY HH:mm')}</p>
                        <p><strong>Amount:</strong> ${formatCurrency(transaction.amount)}</p>
                        <p><strong>Type:</strong> ${transaction.type}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Status:</strong> ${transaction.status}</p>
                        <p><strong>Category:</strong> ${transaction.category}</p>
                        <p><strong>Payment Method:</strong> ${transaction.payment_method}</p>
                        <p><strong>Created By:</strong> ${transaction.created_by}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Description:</strong></p>
                        <p>${transaction.description}</p>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('transactionDetailsContent').innerHTML = detailsHtml;
        $('#transactionDetailsModal').modal('show');
    } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'Failed to load transaction details', 'error');
    }
}

// Utility Functions
function showToast(title, message, type) {
    Toastify({
        text: message,
        duration: 3000,
        gravity: 'top',
        position: 'right',
        backgroundColor: type === 'success' ? '#28a745' : '#dc3545'
    }).showToast();
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount);
}

function downloadReceipt(id) {
    window.open(`/api/v1/transactions/${id}/receipt`, '_blank');
}

// Event Listeners
function setupEventListeners() {
    // Filter changes
    $('.filter-select').on('change', function() {
        window.transactionsTable.ajax.reload();
    });

    // Reset filters
    $('#resetFilters').on('click', function() {
        $('.filter-select').val('');
        $('#dateRange').data('daterangepicker').setStartDate(moment().subtract(30, 'days'));
        $('#dateRange').data('daterangepicker').setEndDate(moment());
        window.transactionsTable.ajax.reload();
    });

    // Export buttons
    $('.export-btn').on('click', function() {
        const format = $(this).data('format');
        exportTransactions(format);
    });
}

// Export Function
function exportTransactions(format) {
    const filters = {
        startDate: $('#startDate').val(),
        endDate: $('#endDate').val(),
        transactionType: $('#typeFilter').val(),
        status: $('#statusFilter').val(),
        category: $('#categoryFilter').val(),
        paymentMethod: $('#paymentMethodFilter').val()
    };

    const queryString = new URLSearchParams(filters).toString();
    window.location.href = `/api/v1/transactions/export/${format}?${queryString}`;
}
</script>
{% endblock %}