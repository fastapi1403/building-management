<!-- app/templates/components/alerts.html -->
<div class="alerts-component" id="alertsContainer">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- System Alerts -->
    <div id="systemAlerts">
        {% if system_maintenance %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="fas fa-tools mr-2"></i>
                System maintenance scheduled for {{ system_maintenance.scheduled_time }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endif %}
    </div>

    <!-- User Session Info -->
    <div id="sessionAlert" class="d-none">
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="fas fa-clock mr-2"></i>
            <span id="sessionTimeRemaining"></span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    </div>

    <!-- Template for Dynamic Alerts -->
    <template id="alertTemplate">
        <div class="alert alert-dismissible fade show" role="alert">
            <i class="fas mr-2"></i>
            <span class="alert-message"></span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    </template>
</div>

<style>
.alerts-component {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    min-width: 300px;
    max-width: 500px;
}

.alert {
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-left: 4px solid;
}

.alert-success {
    border-left-color: #28a745;
}

.alert-info {
    border-left-color: #17a2b8;
}

.alert-warning {
    border-left-color: #ffc107;
}

.alert-danger {
    border-left-color: #dc3545;
}

.alert .close {
    padding: 0.75rem;
}

.alert i {
    vertical-align: middle;
}

@media (max-width: 576px) {
    .alerts-component {
        left: 20px;
        right: 20px;
        min-width: auto;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeAlerts();
    checkSessionTime();
});

function initializeAlerts() {
    // Set current user context
    window.currentUser = {
        username: 'hnejadi',
        lastActive: '2025-01-08T16:18:42Z'
    };

    // Initialize alert handling
    setupAlertListeners();
    checkSystemStatus();
}

function setupAlertListeners() {
    // Auto-dismiss success alerts after 5 seconds
    document.querySelectorAll('.alert-success').forEach(alert => {
        setTimeout(() => {
            $(alert).alert('close');
        }, 5000);
    });
}

function checkSystemStatus() {
    fetch('/api/v1/system/status')
        .then(response => response.json())
        .then(status => {
            if (status.alerts) {
                status.alerts.forEach(alert => showSystemAlert(alert));
            }
        })
        .catch(error => console.error('Error checking system status:', error));
}

function showSystemAlert(alertData) {
    const template = document.getElementById('alertTemplate');
    const alert = template.content.cloneNode(true);

    const alertElement = alert.querySelector('.alert');
    alertElement.classList.add(`alert-${alertData.type}`);

    const icon = alert.querySelector('i');
    icon.classList.add(`fa-${getAlertIcon(alertData.type)}`);

    const message = alert.querySelector('.alert-message');
    message.textContent = alertData.message;

    document.getElementById('systemAlerts').appendChild(alert);
}

function getAlertIcon(type) {
    const icons = {
        success: 'check-circle',
        info: 'info-circle',
        warning: 'exclamation-triangle',
        danger: 'exclamation-circle'
    };
    return icons[type] || 'info-circle';
}

function checkSessionTime() {
    const sessionTimeout = 30 * 60 * 1000; // 30 minutes
    const lastActive = new Date(window.currentUser.lastActive);
    const now = new Date();
    const timeLeft = sessionTimeout - (now - lastActive);

    if (timeLeft <= 5 * 60 * 1000) { // Show warning when 5 minutes left
        showSessionAlert(timeLeft);
    }
}

function showSessionAlert(timeLeft) {
    const minutes = Math.ceil(timeLeft / 60000);
    const sessionAlert = document.getElementById('sessionAlert');
    const timeRemaining = document.getElementById('sessionTimeRemaining');

    timeRemaining.textContent = `Your session will expire in ${minutes} minutes. Please save your work.`;
    sessionAlert.classList.remove('d-none');
}

// Export functions for testing
window.alertUtils = {
    showSystemAlert,
    checkSessionTime,
    getAlertIcon
};
</script>