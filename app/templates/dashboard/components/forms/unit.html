<!-- app/templates/components/forms/unit.html -->
<form id="unitForm" class="needs-validation" novalidate>
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                {% if unit %}Edit Unit{% else %}Add New Unit{% endif %}
            </h5>
        </div>
        <div class="card-body">
            <!-- Unit Basic Information -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="unitNumber">Unit Number <span class="text-danger">*</span></label>
                        <input type="text"
                               class="form-control"
                               id="unitNumber"
                               name="unitNumber"
                               value="{{ unit.unit_number if unit else '' }}"
                               required>
                        <div class="invalid-feedback">Please provide a unit number.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="unitType">Unit Type <span class="text-danger">*</span></label>
                        <select class="form-control" id="unitType" name="unitType" required>
                            <option value="">Select Unit Type</option>
                            <option value="studio" {% if unit and unit.type == 'studio' %}selected{% endif %}>Studio</option>
                            <option value="1bed" {% if unit and unit.type == '1bed' %}selected{% endif %}>1 Bedroom</option>
                            <option value="2bed" {% if unit and unit.type == '2bed' %}selected{% endif %}>2 Bedrooms</option>
                            <option value="3bed" {% if unit and unit.type == '3bed' %}selected{% endif %}>3 Bedrooms</option>
                            <option value="penthouse" {% if unit and unit.type == 'penthouse' %}selected{% endif %}>Penthouse</option>
                        </select>
                        <div class="invalid-feedback">Please select a unit type.</div>
                    </div>
                </div>
            </div>

            <!-- Unit Details -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="floorArea">Floor Area (sq ft) <span class="text-danger">*</span></label>
                        <input type="number"
                               class="form-control"
                               id="floorArea"
                               name="floorArea"
                               value="{{ unit.floor_area if unit else '' }}"
                               min="0"
                               step="0.01"
                               required>
                        <div class="invalid-feedback">Please provide a valid floor area.</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="floor">Floor Number <span class="text-danger">*</span></label>
                        <input type="number"
                               class="form-control"
                               id="floor"
                               name="floor"
                               value="{{ unit.floor if unit else '' }}"
                               required>
                        <div class="invalid-feedback">Please provide a floor number.</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="baseRent">Base Rent <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">$</span>
                            </div>
                            <input type="number"
                                   class="form-control"
                                   id="baseRent"
                                   name="baseRent"
                                   value="{{ unit.base_rent if unit else '' }}"
                                   min="0"
                                   step="0.01"
                                   required>
                            <div class="invalid-feedback">Please provide a valid base rent amount.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unit Features -->
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label>Unit Features</label>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox"
                                   class="custom-control-input"
                                   id="furnished"
                                   name="features[]"
                                   value="furnished"
                                   {% if unit and 'furnished' in unit.features %}checked{% endif %}>
                            <label class="custom-control-label" for="furnished">Furnished</label>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox"
                                   class="custom-control-input"
                                   id="airConditioning"
                                   name="features[]"
                                   value="ac"
                                   {% if unit and 'ac' in unit.features %}checked{% endif %}>
                            <label class="custom-control-label" for="airConditioning">Air Conditioning</label>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox"
                                   class="custom-control-input"
                                   id="balcony"
                                   name="features[]"
                                   value="balcony"
                                   {% if unit and 'balcony' in unit.features %}checked{% endif %}>
                            <label class="custom-control-label" for="balcony">Balcony</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unit Status -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="status">Unit Status <span class="text-danger">*</span></label>
                        <select class="form-control" id="status" name="status" required>
                            <option value="">Select Status</option>
                            <option value="available" {% if unit and unit.status == 'available' %}selected{% endif %}>Available</option>
                            <option value="occupied" {% if unit and unit.status == 'occupied' %}selected{% endif %}>Occupied</option>
                            <option value="maintenance" {% if unit and unit.status == 'maintenance' %}selected{% endif %}>Under Maintenance</option>
                            <option value="reserved" {% if unit and unit.status == 'reserved' %}selected{% endif %}>Reserved</option>
                        </select>
                        <div class="invalid-feedback">Please select a unit status.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="lastInspection">Last Inspection Date</label>
                        <input type="date"
                               class="form-control"
                               id="lastInspection"
                               name="lastInspection"
                               value="{{ unit.last_inspection.strftime('%Y-%m-%d') if unit and unit.last_inspection else '' }}">
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea class="form-control"
                                  id="notes"
                                  name="notes"
                                  rows="3">{{ unit.notes if unit else '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Metadata -->
            <div class="row">
                <div class="col-md-12">
                    <small class="text-muted">
                        {% if unit %}
                            Last updated: {{ moment.utc(unit.updated_at).format('YYYY-MM-DD HH:mm:ss') }} UTC
                            by {{ unit.updated_by }}
                        {% else %}
                            New unit form | Current time: {{ moment.utc('2025-01-08 16:25:46').format('YYYY-MM-DD HH:mm:ss') }} UTC
                            | User: {{ current_user.username }}
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <div class="row">
                <div class="col">
                    <button type="submit" class="btn btn-primary">
                        {{ 'Save Changes' if unit else 'Create Unit' }}
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="history.back()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Scripts section for building.html and unit.html -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeForms();
    setupValidation();
    setupDependentFields();
    initializeFileUploads();
});

// Form Initialization
function initializeForms() {
    const contextData = {
        currentUser: 'hnejadi',
        timestamp: '2025-01-08T16:27:47Z',
        formType: document.querySelector('form').dataset.formType
    };

    // Initialize select2 for dropdown fields
    $('.select2-field').select2({
        theme: 'bootstrap4',
        width: '100%'
    });

    // Initialize datepicker fields
    $('.datepicker').daterangepicker({
        singleDatePicker: true,
        showDropdowns: true,
        locale: {
            format: 'YYYY-MM-DD'
        }
    });

    // Initialize currency inputs
    $('.currency-input').mask('#,##0.00', {
        reverse: true
    });

    // Setup form auto-save
    setupAutoSave(contextData);
}

// Form Validation
function setupValidation() {
    const forms = document.querySelectorAll('.needs-validation');

    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                highlightInvalidFields(form);
            }
            form.classList.add('was-validated');
        });

        // Real-time validation
        form.querySelectorAll('input, select, textarea').forEach(field => {
            field.addEventListener('change', () => validateField(field));
        });
    });
}

function validateField(field) {
    const value = field.value.trim();
    const validationRules = JSON.parse(field.dataset.validation || '{}');

    let isValid = true;
    const errors = [];

    if (validationRules.required && !value) {
        isValid = false;
        errors.push('This field is required');
    }

    if (validationRules.minLength && value.length < validationRules.minLength) {
        isValid = false;
        errors.push(`Minimum length is ${validationRules.minLength} characters`);
    }

    if (validationRules.pattern && !new RegExp(validationRules.pattern).test(value)) {
        isValid = false;
        errors.push(validationRules.patternMessage || 'Invalid format');
    }

    updateFieldValidation(field, isValid, errors);
}

// Dependent Fields Management
function setupDependentFields() {
    // Building-specific dependencies
    if (document.querySelector('[data-form-type="building"]')) {
        setupBuildingDependencies();
    }

    // Unit-specific dependencies
    if (document.querySelector('[data-form-type="unit"]')) {
        setupUnitDependencies();
    }
}

function setupBuildingDependencies() {
    const buildingTypeSelect = document.getElementById('buildingType');
    if (buildingTypeSelect) {
        buildingTypeSelect.addEventListener('change', function() {
            updateRequiredAmenities(this.value);
            updateMaintenanceSchedule(this.value);
        });
    }
}

function setupUnitDependencies() {
    const unitTypeSelect = document.getElementById('unitType');
    if (unitTypeSelect) {
        unitTypeSelect.addEventListener('change', function() {
            updateUnitFeatures(this.value);
            updatePricingTiers(this.value);
        });
    }
}

// File Upload Handling
function initializeFileUploads() {
    const dropzones = document.querySelectorAll('.dropzone');

    dropzones.forEach(dropzone => {
        new Dropzone(dropzone, {
            url: '/api/v1/uploads',
            maxFilesize: 5,
            acceptedFiles: '.jpg,.png,.pdf,.doc,.docx',
            headers: {
                'X-User': 'hnejadi',
                'X-Timestamp': '2025-01-08T16:27:47Z'
            },
            init: function() {
                this.on('success', file => handleUploadSuccess(file));
                this.on('error', (file, error) => handleUploadError(file, error));
            }
        });
    });
}

// Auto-save Functionality
function setupAutoSave(contextData) {
    let autoSaveTimeout;
    const form = document.querySelector('form');

    form.addEventListener('input', () => {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => saveFormData(form, contextData), 3000);
    });
}

async function saveFormData(form, contextData) {
    const formData = new FormData(form);
    formData.append('_user', contextData.currentUser);
    formData.append('_timestamp', contextData.timestamp);

    try {
        const response = await fetch('/api/v1/forms/autosave', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            showAutoSaveSuccess();
        } else {
            showAutoSaveError();
        }
    } catch (error) {
        console.error('Auto-save error:', error);
        showAutoSaveError();
    }
}

// Utility Functions
function updateFieldValidation(field, isValid, errors) {
    const feedback = field.nextElementSibling;
    if (feedback && feedback.classList.contains('invalid-feedback')) {
        feedback.textContent = errors.join('. ');
    }

    field.classList.toggle('is-invalid', !isValid);
    field.classList.toggle('is-valid', isValid);
}

function highlightInvalidFields(form) {
    form.querySelectorAll(':invalid').forEach(field => {
        field.classList.add('is-invalid');
    });
}

function showAutoSaveSuccess() {
    const toast = createToast('Auto-saved successfully', 'success');
    showToast(toast);
}

function showAutoSaveError() {
    const toast = createToast('Failed to auto-save', 'error');
    showToast(toast);
}

function createToast(message, type) {
    return `
        <div class="toast" role="alert">
            <div class="toast-header bg-${type}">
                <strong class="mr-auto">Form Auto-save</strong>
                <small>${moment().format('HH:mm:ss')}</small>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast">&times;</button>
            </div>
            <div class="toast-body">${message}</div>
        </div>
    `;
}

function showToast(toast) {
    const toastContainer = document.getElementById('toastContainer');
    toastContainer.insertAdjacentHTML('beforeend', toast);
    $('.toast').toast('show');
}

// Export utilities for testing
window.formUtils = {
    validateField,
    updateFieldValidation,
    saveFormData,
    createToast
};
</script>