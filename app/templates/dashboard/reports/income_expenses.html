{% extends "dashboard/base.html" %}
{% block title %}Income & Expenses Report{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Income & Expenses Report</h1>
        <div class="btn-group">
            <button class="btn btn-success dropdown-toggle" type="button" data-toggle="dropdown">
                <i class="fas fa-file-export"></i> Export Report
            </button>
            <div class="dropdown-menu">
                <a class="dropdown-item" href="#" onclick="exportReport('csv')">CSV</a>
                <a class="dropdown-item" href="#" onclick="exportReport('excel')">Excel</a>
                <a class="dropdown-item" href="#" onclick="exportReport('pdf')">PDF</a>
            </div>
        </div>
    </div>

    <!-- Filters Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="form-group">
                <label>Date Range</label>
                <input type="text" class="form-control" id="dateRange">
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label>Category</label>
                <select class="form-control" id="categoryFilter">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label>Type</label>
                <select class="form-control" id="typeFilter">
                    <option value="">All Types</option>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label>Status</label>
                <select class="form-control" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Summary Cards Row -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Income</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalIncome">$0.00</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Total Expenses</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalExpenses">$0.00</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-minus-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Net Balance</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="netBalance">$0.00</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-balance-scale fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total Transactions</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalTransactions">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exchange-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-xl-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Monthly Income vs Expenses</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="monthlyTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Category Distribution</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie">
                        <canvas id="categoryPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Detailed Transactions</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="transactionsTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    initializeDataTables();
    setupDateRangePicker();
    setupEventListeners();
});

function initializeCharts() {
    // Monthly Income vs Expenses Chart
    const monthlyChartCtx = document.getElementById('monthlyChart').getContext('2d');
    const yearlyChartCtx = document.getElementById('yearlyChart').getContext('2d');
    const categoryChartCtx = document.getElementById('categoryChart').getContext('2d');

    // Fetch and initialize charts
    fetchChartData('/api/v1/reports/monthly-income-expenses', data => {
        new Chart(monthlyChartCtx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Income',
                    data: data.income,
                    backgroundColor: '#28a745',
                    borderColor: '#1e7e34',
                    borderWidth: 1
                }, {
                    label: 'Expenses',
                    data: data.expenses,
                    backgroundColor: '#dc3545',
                    borderColor: '#bd2130',
                    borderWidth: 1
                }]
            },
            options: getChartOptions('Monthly Income vs Expenses')
        });
    });

    // Yearly Trend Chart
    fetchChartData('/api/v1/reports/yearly-income-expenses', data => {
        new Chart(yearlyChartCtx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Income',
                    data: data.income,
                    borderColor: '#28a745',
                    fill: false,
                    tension: 0.1
                }, {
                    label: 'Expenses',
                    data: data.expenses,
                    borderColor: '#dc3545',
                    fill: false,
                    tension: 0.1
                }, {
                    label: 'Net Income',
                    data: data.netIncome,
                    borderColor: '#17a2b8',
                    fill: false,
                    tension: 0.1
                }]
            },
            options: getChartOptions('Yearly Trends')
        });
    });

    // Category Distribution Chart
    fetchChartData('/api/v1/reports/category-distribution', data => {
        new Chart(categoryChartCtx, {
            type: 'doughnut',
            data: {
                labels: data.categories,
                datasets: [{
                    data: data.amounts,
                    backgroundColor: [
                        '#28a745', '#dc3545', '#ffc107', '#17a2b8',
                        '#6610f2', '#e83e8c', '#fd7e14', '#20c997'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Expense Distribution by Category'
                    }
                }
            }
        });
    });
}

function initializeDataTables() {
    $('#transactionsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/api/v1/reports/transactions',
            data: function(d) {
                return {
                    ...d,
                    dateRange: $('#dateRange').val(),
                    type: $('#typeFilter').val(),
                    category: $('#categoryFilter').val()
                };
            }
        },
        columns: [
            { data: 'date', render: data => moment(data).format('DD/MM/YYYY') },
            { data: 'description' },
            {
                data: 'amount',
                render: function(data, type, row) {
                    const amount = parseFloat(data);
                    const color = row.type === 'income' ? 'text-success' : 'text-danger';
                    return `<span class="${color}">${amount.toLocaleString('en-US', {
                        style: 'currency',
                        currency: 'USD'
                    })}</span>`;
                }
            },
            { data: 'category' },
            { data: 'type' },
            {
                data: 'status',
                render: function(data) {
                    const statusClasses = {
                        'pending': 'bg-warning',
                        'completed': 'bg-success',
                        'failed': 'bg-danger'
                    };
                    return `<span class="badge ${statusClasses[data]}">${data}</span>`;
                }
            }
        ],
        order: [[0, 'desc']],
        responsive: true,
        dom: 'Bfrtip',
        buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
    });
}

function setupDateRangePicker() {
    $('#dateRange').daterangepicker({
        ranges: {
            'Today': [moment(), moment()],
            'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
            'Last 7 Days': [moment().subtract(6, 'days'), moment()],
            'Last 30 Days': [moment().subtract(29, 'days'), moment()],
            'This Month': [moment().startOf('month'), moment().endOf('month')],
            'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
            'This Year': [moment().startOf('year'), moment().endOf('year')],
            'Last Year': [moment().subtract(1, 'year').startOf('year'), moment().subtract(1, 'year').endOf('year')]
        },
        startDate: moment().startOf('month'),
        endDate: moment().endOf('month')
    }, function(start, end) {
        refreshData();
    });
}

function setupEventListeners() {
    $('.filter-select').on('change', function() {
        refreshData();
    });

    $('#refreshData').on('click', function() {
        refreshData();
    });

    $('#exportBtn').on('click', function() {
        exportData($('#exportFormat').val());
    });
}

function refreshData() {
    updateSummaryCards();
    $('#transactionsTable').DataTable().ajax.reload();
    initializeCharts();
}

function updateSummaryCards() {
    const params = new URLSearchParams({
        dateRange: $('#dateRange').val(),
        type: $('#typeFilter').val(),
        category: $('#categoryFilter').val()
    });

    fetch(`/api/v1/reports/summary?${params}`)
        .then(response => response.json())
        .then(data => {
            $('#totalIncome').text(formatCurrency(data.totalIncome));
            $('#totalExpenses').text(formatCurrency(data.totalExpenses));
            $('#netIncome').text(formatCurrency(data.netIncome));
            $('#transactionCount').text(data.transactionCount);
        })
        .catch(error => console.error('Error updating summary:', error));
}

function exportData(format) {
    const params = new URLSearchParams({
        dateRange: $('#dateRange').val(),
        type: $('#typeFilter').val(),
        category: $('#categoryFilter').val(),
        format: format
    });

    window.location.href = `/api/v1/reports/export?${params}`;
}

function fetchChartData(url, callback) {
    const params = new URLSearchParams({
        dateRange: $('#dateRange').val(),
        type: $('#typeFilter').val(),
        category: $('#categoryFilter').val()
    });

    fetch(`${url}?${params}`)
        .then(response => response.json())
        .then(callback)
        .catch(error => console.error('Error fetching chart data:', error));
}

function getChartOptions(title) {
    return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            },
            title: {
                display: true,
                text: title
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: value => '$' + value.toLocaleString()
                }
            }
        }
    };
}

function formatCurrency(amount) {
    return amount.toLocaleString('en-US', {
        style: 'currency',
        currency: 'USD'
    });
}
</script>
{% endblock %}