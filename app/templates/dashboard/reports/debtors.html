{% block extra_js %}
{% extends "dashboard/base.html" %}
{% block title %}Property Management - Debtors Report{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Debtors Report</h1>
        <div class="btn-group">
            <button class="btn btn-success dropdown-toggle" type="button" data-toggle="dropdown">
                <i class="fas fa-file-export"></i> Export Report
            </button>
            <div class="dropdown-menu">
                <a class="dropdown-item" href="#" onclick="exportDebtorsReport('csv')">CSV</a>
                <a class="dropdown-item" href="#" onclick="exportDebtorsReport('excel')">Excel</a>
                <a class="dropdown-item" href="#" onclick="exportDebtorsReport('pdf')">PDF</a>
            </div>
        </div>
    </div>

    <!-- Filters Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="form-group">
                <label for="dateRange">Date Range</label>
                <input type="text" class="form-control" id="dateRange">
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label for="buildingFilter">Building</label>
                <select class="form-control filter-select" id="buildingFilter">
                    <option value="">All Buildings</option>
                    {% for building in buildings %}
                    <option value="{{ building.id }}">{{ building.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label for="debtTypeFilter">Debt Type</label>
                <select class="form-control filter-select" id="debtTypeFilter">
                    <option value="">All Types</option>
                    <option value="maintenance">Maintenance Fee</option>
                    <option value="utility">Utility Bills</option>
                    <option value="parking">Parking Fee</option>
                    <option value="other">Other Charges</option>
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label for="statusFilter">Status</label>
                <select class="form-control filter-select" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="partial">Partially Paid</option>
                    <option value="overdue">Overdue</option>
                    <option value="legal">Legal Action</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Summary Cards Row -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Outstanding</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalOutstanding">$0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Overdue Amount</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="overdueAmount">$0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Total Debtors</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalDebtors">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Average Debt Age</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="avgDebtAge">0 days</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-xl-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Debt Distribution by Type</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="debtTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Aging Analysis</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="agingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debtors Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Debtors List</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="debtorsTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Unit</th>
                            <th>Tenant/Owner</th>
                            <th>Outstanding Amount</th>
                            <th>Debt Type</th>
                            <th>Due Date</th>
                            <th>Days Overdue</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="debtorDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Debtor Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="debtorDetailsContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="sendReminderBtn">Send Reminder</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeDebtorsTable();
    initializeDebtorsCharts();
    setupFilters();
});

// Initialize DataTable for debtors
function initializeDebtorsTable() {
    $('#debtorsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/api/v1/reports/debtors',
            data: function(d) {
                return {
                    ...d,
                    dateRange: $('#dateRange').val(),
                    propertyId: $('#propertyFilter').val(),
                    debtStatus: $('#statusFilter').val(),
                    minAmount: $('#minAmountFilter').val(),
                    maxAmount: $('#maxAmountFilter').val()
                };
            }
        },
        columns: [
            { data: 'tenant_name' },
            { data: 'property_unit' },
            { 
                data: 'total_debt',
                render: function(data) {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD'
                    }).format(data);
                }
            },
            { 
                data: 'last_payment_date',
                render: function(data) {
                    return data ? moment(data).format('DD/MM/YYYY') : 'No payments';
                }
            },
            { 
                data: 'days_overdue',
                render: function(data) {
                    const severityClass = data > 90 ? 'text-danger' : 
                                        data > 60 ? 'text-warning' : 
                                        data > 30 ? 'text-primary' : 'text-success';
                    return `<span class="${severityClass}">${data} days</span>`;
                }
            },
            { 
                data: 'status',
                render: function(data) {
                    const statusClasses = {
                        'critical': 'bg-danger',
                        'warning': 'bg-warning',
                        'normal': 'bg-success',
                        'pending': 'bg-info'
                    };
                    return `<span class="badge ${statusClasses[data.toLowerCase()]}">${data}</span>`;
                }
            },
            {
                data: null,
                render: function(data, type, row) {
                    return `
                        <div class="btn-group">
                            <button class="btn btn-sm btn-primary" onclick="viewDebtDetails(${row.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="recordPayment(${row.id})">
                                <i class="fas fa-dollar-sign"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="sendReminder(${row.id})">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        order: [[4, 'desc']],
        responsive: true,
        dom: 'Bfrtip',
        buttons: [
            'copy', 'csv', 'excel', 'pdf', 'print'
        ]
    });
}

// Initialize Charts
function initializeDebtorsCharts() {
    initializeDebtAgingChart();
    initializeDebtTrendChart();
    initializeDebtDistributionChart();
}

// Debt Aging Chart
function initializeDebtAgingChart() {
    const ctx = document.getElementById('debtAgingChart').getContext('2d');
    fetch('/api/v1/reports/debtors/aging')
        .then(response => response.json())
        .then(data => {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-30 days', '31-60 days', '61-90 days', '90+ days'],
                    datasets: [{
                        label: 'Outstanding Amount',
                        data: data.amounts,
                        backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '$' + value.toLocaleString()
                            }
                        }
                    }
                }
            });
        });
}

// Debt Trend Chart
function initializeDebtTrendChart() {
    const ctx = document.getElementById('debtTrendChart').getContext('2d');
    fetch('/api/v1/reports/debtors/trend')
        .then(response => response.json())
        .then(data => {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [{
                        label: 'Total Outstanding Debt',
                        data: data.amounts,
                        borderColor: '#4e73df',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '$' + value.toLocaleString()
                            }
                        }
                    }
                }
            });
        });
}

// Debt Distribution Chart
function initializeDebtDistributionChart() {
    const ctx = document.getElementById('debtDistributionChart').getContext('2d');
    fetch('/api/v1/reports/debtors/distribution')
        .then(response => response.json())
        .then(data => {
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.properties,
                    datasets: [{
                        data: data.amounts,
                        backgroundColor: [
                            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        });
}

// Setup Filters
function setupFilters() {
    // Date Range Picker
    $('#dateRange').daterangepicker({
        ranges: {
            'All Time': [moment().subtract(10, 'years'), moment()],
            'This Month': [moment().startOf('month'), moment().endOf('month')],
            'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
            'Last 3 Months': [moment().subtract(3, 'months'), moment()],
            'Last 6 Months': [moment().subtract(6, 'months'), moment()],
            'This Year': [moment().startOf('year'), moment()]
        },
        startDate: moment().subtract(6, 'months'),
        endDate: moment()
    }, function(start, end) {
        refreshReport();
    });

    // Other Filters
    $('.filter-select, .filter-input').on('change', refreshReport);
}

// Utility Functions
function refreshReport() {
    $('#debtorsTable').DataTable().ajax.reload();
    initializeDebtorsCharts();
    updateSummaryStats();
}

function updateSummaryStats() {
    const filters = {
        dateRange: $('#dateRange').val(),
        propertyId: $('#propertyFilter').val(),
        debtStatus: $('#statusFilter').val()
    };

    fetch('/api/v1/reports/debtors/summary?' + new URLSearchParams(filters))
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalDebt').textContent = formatCurrency(data.totalDebt);
            document.getElementById('averageDebt').textContent = formatCurrency(data.averageDebt);
            document.getElementById('totalDebtors').textContent = data.totalDebtors;
            document.getElementById('criticalCases').textContent = data.criticalCases;
        });
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount);
}

// Action Functions
function viewDebtDetails(debtorId) {
    window.location.href = `/dashboard/reports/debtors/${debtorId}/details`;
}

function recordPayment(debtorId) {
    $('#paymentModal').modal('show');
    document.getElementById('debtorId').value = debtorId;
}

function sendReminder(debtorId) {
    if (confirm('Are you sure you want to send a payment reminder?')) {
        fetch(`/api/v1/debtors/${debtorId}/remind`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            showToast('Success', 'Payment reminder sent successfully', 'success');
        })
        .catch(error => {
            showToast('Error', 'Failed to send reminder', 'error');
        });
    }
}

function showToast(title, message, type) {
    Toastify({
        text: message,
        duration: 3000,
        gravity: 'top',
        position: 'right',
        backgroundColor: type === 'success' ? '#28a745' : '#dc3545'
    }).showToast();
}

// Export Function
function exportCosts(format) {
    const filters = {
        dateRange: $('#dateRange').val(),
        propertyId: $('#propertyFilter').val(),
        debtStatus: $('#statusFilter').val(),
        minAmount: $('#minAmountFilter').val(),
        maxAmount: $('#maxAmountFilter').val()
    };

    window.location.href = `/api/v1/reports/debtors/export/${format}?${new URLSearchParams(filters)}`;
}
</script>
{% endblock %}