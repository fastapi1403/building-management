{% extends "dashboard/base.html" %}
{% block title %}Property Management - Utility Usage Reports{% endblock %}

{% block extra_css %}
<link href="/static/vendor/daterangepicker/daterangepicker.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Utility Usage Reports</h1>
        <div class="btn-group">
            <button class="btn btn-success dropdown-toggle" type="button" data-toggle="dropdown">
                <i class="fas fa-file-export"></i> Export Report
            </button>
            <div class="dropdown-menu">
                <a class="dropdown-item" href="#" onclick="exportUtilityData('csv')">CSV</a>
                <a class="dropdown-item" href="#" onclick="exportUtilityData('excel')">Excel</a>
                <a class="dropdown-item" href="#" onclick="exportUtilityData('pdf')">PDF</a>
            </div>
        </div>
    </div>

    <!-- Filters Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="form-group">
                <label for="dateRange">Date Range</label>
                <input type="text" class="form-control" id="dateRange">
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label for="utilityType">Utility Type</label>
                <select class="form-control filter-select" id="utilityType">
                    <option value="all">All Utilities</option>
                    <option value="electricity">Electricity</option>
                    <option value="water">Water</option>
                    <option value="gas">Gas</option>
                    <option value="heating">Heating</option>
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label for="buildingFilter">Building</label>
                <select class="form-control filter-select" id="buildingFilter">
                    <option value="all">All Buildings</option>
                    {% for building in buildings %}
                    <option value="{{ building.id }}">{{ building.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label>&nbsp;</label>
                <button class="btn btn-primary btn-block" id="refreshData">
                    <i class="fas fa-sync"></i> Refresh Data
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Cards Row -->
    <div class="row">
        <!-- Total Consumption Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Consumption</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalConsumption">Loading...</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-tachometer-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Average Daily Usage Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Average Daily Usage</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="avgDailyUsage">Loading...</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-day fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Peak Usage Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Peak Usage</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="peakUsage">Loading...</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bolt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cost Estimation Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Estimated Cost</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="estimatedCost">Loading...</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <!-- Monthly Usage Trend -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Monthly Usage Trend</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="monthlyUsageChart" style="height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage Distribution -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Usage Distribution</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie">
                        <canvas id="usageDistributionChart" style="height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Usage Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Detailed Usage Data</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="utilityTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Building</th>
                            <th>Unit</th>
                            <th>Utility Type</th>
                            <th>Usage</th>
                            <th>Cost</th>
                            <th>Peak Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{#<script src="/static/vendor/moment/moment.min.js"></script>#}
{#<script src="/static/vendor/daterangepicker/daterangepicker.js"></script>#}
{#<script src="/static/vendor/chart.js/Chart.min.js"></script>#}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeDateTimeHandling();
    setupRefreshTimers();
    setupTimeZoneHandling();
});

function initializeDateTimeHandling() {
    // Initialize current UTC time display
    const utcDisplay = document.getElementById('utcTimeDisplay');
    const userDisplay = document.getElementById('userTimeDisplay');
    const lastUpdateDisplay = document.getElementById('lastUpdateDisplay');

    // Set initial UTC time
    const initialUTC = moment.utc('2025-01-08 15:38:06');
    updateTimeDisplays(initialUTC);

    // Setup timezone selector if present
    if (document.getElementById('timeZoneSelector')) {
        populateTimeZones();
    }
}

function updateTimeDisplays(utcTime) {
    const localTime = utcTime.local();

    // Update displays with formatted times
    if (document.getElementById('utcTimeDisplay')) {
        document.getElementById('utcTimeDisplay').textContent = utcTime.format('YYYY-MM-DD HH:mm:ss [UTC]');
    }

    if (document.getElementById('userTimeDisplay')) {
        document.getElementById('userTimeDisplay').textContent = localTime.format('YYYY-MM-DD HH:mm:ss [Local]');
    }

    if (document.getElementById('userInfo')) {
        document.getElementById('userInfo').textContent = 'User: hnejadi';
    }

    // Update last refresh timestamp
    updateLastRefreshTime();
}

function setupRefreshTimers() {
    // Auto-refresh timer for time displays
    setInterval(() => {
        const currentUTC = moment.utc();
        updateTimeDisplays(currentUTC);
    }, 1000);

    // Auto-refresh data every 5 minutes
    setInterval(refreshData, 300000);
}

function setupTimeZoneHandling() {
    const userTimeZone = moment.tz.guess();

    // Store user's timezone preference
    localStorage.setItem('userTimeZone', userTimeZone);

    // Initialize timezone converter if present
    if (document.getElementById('tzConverter')) {
        initializeTimeZoneConverter();
    }
}

function initializeTimeZoneConverter() {
    const converter = document.getElementById('tzConverter');

    converter.addEventListener('submit', (e) => {
        e.preventDefault();
        const sourceTime = document.getElementById('sourceTime').value;
        const sourceZone = document.getElementById('sourceZone').value;
        const targetZone = document.getElementById('targetZone').value;

        const converted = convertBetweenTimeZones(sourceTime, sourceZone, targetZone);
        displayConvertedTime(converted);
    });
}

function convertBetweenTimeZones(time, fromZone, toZone) {
    return moment.tz(time, fromZone).tz(toZone);
}

function populateTimeZones() {
    const timeZones = moment.tz.names();
    const selector = document.getElementById('timeZoneSelector');

    timeZones.forEach(zone => {
        const option = document.createElement('option');
        option.value = zone;
        option.textContent = zone;
        selector.appendChild(option);
    });

    // Set current timezone as selected
    selector.value = moment.tz.guess();
}

function updateLastRefreshTime() {
    if (document.getElementById('lastUpdateDisplay')) {
        const now = moment();
        document.getElementById('lastUpdateDisplay').textContent =
            `Last updated: ${now.format('YYYY-MM-DD HH:mm:ss')}`;
    }
}

function refreshData() {
    // Fetch updated data from server
    fetch('/api/v1/refresh-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            timestamp: moment.utc().format(),
            user: 'hnejadi'
        })
    })
    .then(response => response.json())
    .then(data => {
        updateDataDisplays(data);
        updateLastRefreshTime();
    })
    .catch(error => console.error('Error refreshing data:', error));
}

function updateDataDisplays(data) {
    // Update any data displays on the page
    if (data.times) {
        Object.entries(data.times).forEach(([key, value]) => {
            const element = document.getElementById(`time-${key}`);
            if (element) {
                element.textContent = moment(value).format('YYYY-MM-DD HH:mm:ss');
            }
        });
    }
}

// Export functions for testing
window.dateTimeUtils = {
    updateTimeDisplays,
    convertBetweenTimeZones,
    updateLastRefreshTime
};
</script>
{% endblock %}