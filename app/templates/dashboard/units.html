{% extends "base.html" %}

{% block title %}Units Management - Building Management System{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('buildings') }}">Buildings</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('floors') }}">Floors</a></li>
<li class="breadcrumb-item active">Units</li>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
        <h1 class="h2">Unit Management</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-outline-secondary" onclick="exportUnitsData()">
                    <i class="fas fa-download"></i> Export
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="printUnitsData()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUnitModal">
                <i class="fas fa-plus"></i> Add New Unit
            </button>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-md-2">
            <select class="form-select" id="buildingFilter">
                <option value="">All Buildings</option>
                {% for building in buildings %}
                <option value="{{ building.id }}">{{ building.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="floorFilter">
                <option value="">All Floors</option>
                {% for floor in floors %}
                <option value="{{ floor.id }}">Floor {{ floor.floor_number }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="statusFilter">
                <option value="">All Status</option>
                <option value="occupied">Occupied</option>
                <option value="vacant">Vacant</option>
            </select>
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" id="searchUnit" placeholder="Search units...">
        </div>
        <div class="col-md-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="toggleView('grid')">
                    <i class="fas fa-th-large"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="toggleView('list')">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Units View Container -->
    <div id="unitsContainer" class="row g-4">
        {% for unit in units %}
        <div class="col-md-4 unit-card"
             data-building="{{ unit.floor.building_id }}"
             data-floor="{{ unit.floor_id }}"
             data-status="{{ 'occupied' if unit.is_occupied else 'vacant' }}">
            <div class="card h-100 {% if unit.is_occupied %}border-success{% else %}border-warning{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Unit {{ unit.unit_number }}</h5>
                    <div class="dropdown">
                        <button class="btn btn-link" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="#" onclick="editUnit({{ unit.id }})">
                                    <i class="fas fa-edit"></i> Edit Unit
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="manageOwner({{ unit.id }})">
                                    <i class="fas fa-user-tie"></i> Manage Owner
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="manageTenant({{ unit.id }})">
                                    <i class="fas fa-users"></i> Manage Tenant
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="viewCharges({{ unit.id }})">
                                    <i class="fas fa-file-invoice-dollar"></i> View Charges
                                </a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" onclick="deleteUnit({{ unit.id }})">
                                    <i class="fas fa-trash"></i> Delete Unit
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Unit Details -->
                        <div class="col-6">
                            <div class="stat-card">
                                <span class="stat-label">Area</span>
                                <span class="stat-value">{{ unit.area }} m²</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card">
                                <span class="stat-label">Status</span>
                                <span class="badge {% if unit.is_occupied %}bg-success{% else %}bg-warning{% endif %}">
                                    {{ "Occupied" if unit.is_occupied else "Vacant" }}
                                </span>
                            </div>
                        </div>

                        <!-- Owner Info -->
                        <div class="col-12">
                            <div class="info-section">
                                <h6><i class="fas fa-user-tie"></i> Owner</h6>
                                {% if unit.owner %}
                                <p class="mb-1">{{ unit.owner.name }}</p>
                                <small>
                                    <i class="fas fa-phone"></i> {{ unit.owner.phone }}<br>
                                    <i class="fas fa-envelope"></i> {{ unit.owner.email }}
                                </small>
                                {% else %}
                                <p class="text-muted">No owner assigned</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Tenant Info -->
                        <div class="col-12">
                            <div class="info-section">
                                <h6><i class="fas fa-users"></i> Tenant</h6>
                                {% if unit.tenant %}
                                <p class="mb-1">{{ unit.tenant.name }}</p>
                                <small>
                                    <i class="fas fa-users"></i> {{ unit.resident_count }} residents<br>
                                    <i class="fas fa-phone"></i> {{ unit.tenant.phone }}
                                </small>
                                {% else %}
                                <p class="text-muted">No tenant assigned</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Financial Summary -->
                        <div class="col-12">
                            <div class="info-section">
                                <h6><i class="fas fa-file-invoice-dollar"></i> Financial Summary</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Monthly Charge:</small>
                                        <p>${{ unit.constant_extra_charge|format_currency }}</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Pending:</small>
                                        <p>${{ unit.pending_charges|format_currency }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">
                        Last Updated: {{ unit.updated_at|time_ago }}
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Add/Edit Unit Modal -->
    <div class="modal fade" id="unitModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="unitModalTitle">Add New Unit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="unitForm" onsubmit="return handleUnitSubmit(event)">
                    <div class="modal-body">
                        <input type="hidden" id="unitId" name="id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Floor</label>
                                <select class="form-select" id="floorSelect" name="floor_id" required>
                                    {% for floor in floors %}
                                    <option value="{{ floor.id }}">
                                        {{ floor.building.name }} - Floor {{ floor.floor_number }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Unit Number</label>
                                <input type="text" class="form-control" id="unitNumber" name="unit_number" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Area (m²)</label>
                                <input type="number" step="0.01" class="form-control" id="area" name="area" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Extra Monthly Charge</label>
                                <input type="number" step="0.01" class="form-control" id="extraCharge" name="constant_extra_charge">
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="hasParking" name="has_parking">
                                    <label class="form-check-label">Has Parking</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Parking Space Number</label>
                                <input type="text" class="form-control" id="parkingNumber" name="parking_space_number">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Unit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize filters and datatable
    initializeDataTable();
    initializeFilters();
    initializeCharts();
});

// Initialize DataTable with advanced features
function initializeDataTable() {
    const unitsTable = $('#unitsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/api/v1/units/datatable',
            type: 'POST',
            data: function(d) {
                return {
                    ...d,
                    building_id: $('#buildingFilter').val(),
                    floor_id: $('#floorFilter').val(),
                    status: $('#statusFilter').val(),
                    occupancy: $('#occupancyFilter').val()
                };
            }
        },
        columns: [
            { data: 'unit_number' },
            { data: 'floor.building.name' },
            { data: 'floor.floor_number' },
            { data: 'area' },
            {
                data: 'has_parking',
                render: function(data, type, row) {
                    return data ? `<span class="badge bg-success">Yes - ${row.parking_space_number}</span>`
                               : '<span class="badge bg-secondary">No</span>';
                }
            },
            {
                data: 'is_occupied',
                render: function(data, type, row) {
                    return data ? '<span class="badge bg-success">Occupied</span>'
                               : '<span class="badge bg-danger">Vacant</span>';
                }
            },
            {
                data: null,
                render: function(data, type, row) {
                    return `
                        <div class="btn-group">
                            <button class="btn btn-sm btn-primary" onclick="editUnit(${row.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-info" onclick="viewDetails(${row.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUnit(${row.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        order: [[0, 'asc']],
        responsive: true,
        dom: 'Bfrtip',
        buttons: [
            'copy', 'csv', 'excel', 'pdf', 'print'
        ]
    });

    // Refresh table when filters change
    $('.filter-select').on('change', function() {
        unitsTable.ajax.reload();
    });
}

// Initialize filter dependencies
function initializeFilters() {
    // Building filter change handler
    $('#buildingFilter').on('change', function() {
        const buildingId = $(this).val();
        updateFloorFilter(buildingId);
    });

    // Initialize floor filter based on selected building
    function updateFloorFilter(buildingId) {
        const floorSelect = $('#floorFilter');
        floorSelect.empty().append('<option value="">All Floors</option>');

        if (buildingId) {
            fetch(`/api/v1/buildings/${buildingId}/floors`)
                .then(response => response.json())
                .then(floors => {
                    floors.forEach(floor => {
                        floorSelect.append(
                            `<option value="${floor.id}">Floor ${floor.floor_number}</option>`
                        );
                    });
                })
                .catch(error => console.error('Error loading floors:', error));
        }
    }
}

// Unit CRUD Operations
async function handleUnitSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const unitId = document.getElementById('unitId').value;

    try {
        const response = await fetch(`/api/v1/units/${unitId || ''}`, {
            method: unitId ? 'PUT' : 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(Object.fromEntries(formData)),
        });

        if (response.ok) {
            $('#unitsTable').DataTable().ajax.reload();
            $('#unitModal').modal('hide');
            showToast('Success', 'Unit saved successfully', 'success');
        } else {
            const error = await response.json();
            showToast('Error', error.detail, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'An error occurred while saving the unit', 'error');
    }
}

async function editUnit(unitId) {
    try {
        const response = await fetch(`/api/v1/units/${unitId}`);
        const unit = await response.json();

        // Populate form fields
        Object.keys(unit).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
                element.value = unit[key];
            }
        });

        // Update modal title and show
        document.getElementById('unitModalTitle').textContent = 'Edit Unit';
        $('#unitModal').modal('show');
    } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'Error loading unit data', 'error');
    }
}

async function deleteUnit(unitId) {
    if (await confirmDialog('Are you sure you want to delete this unit?')) {
        try {
            const response = await fetch(`/api/v1/units/${unitId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                $('#unitsTable').DataTable().ajax.reload();
                showToast('Success', 'Unit deleted successfully', 'success');
            } else {
                throw new Error('Failed to delete unit');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error', 'Error deleting unit', 'error');
        }
    }
}

async function viewDetails(unitId) {
    try {
        const response = await fetch(`/api/v1/units/${unitId}/details`);
        const details = await response.json();

        // Populate details modal
        document.getElementById('unitDetailsContent').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h5>Unit Information</h5>
                    <p><strong>Unit Number:</strong> ${details.unit_number}</p>
                    <p><strong>Area:</strong> ${details.area} m²</p>
                    <p><strong>Status:</strong> ${details.is_occupied ? 'Occupied' : 'Vacant'}</p>
                    <p><strong>Parking:</strong> ${details.has_parking ? `Yes - ${details.parking_space_number}` : 'No'}</p>
                </div>
                <div class="col-md-6">
                    <h5>Current Charges</h5>
                    <p><strong>Total Pending:</strong> $${details.pending_charges}</p>
                    <p><strong>Last Payment:</strong> ${details.last_payment_date || 'N/A'}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h5>Resident Information</h5>
                    ${details.tenant ? `
                        <p><strong>Tenant:</strong> ${details.tenant.name}</p>
                        <p><strong>Contact:</strong> ${details.tenant.phone}</p>
                        <p><strong>Occupants:</strong> ${details.tenant.occupant_count}</p>
                    ` : '<p>No current tenant</p>'}
                </div>
            </div>
        `;

        $('#unitDetailsModal').modal('show');
    } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'Error loading unit details', 'error');
    }
}

// Chart Initialization
function initializeCharts() {
    // Occupancy Status Chart
    const occupancyCtx = document.getElementById('occupancyChart').getContext('2d');
    new Chart(occupancyCtx, {
        type: 'doughnut',
        data: {
            labels: ['Occupied', 'Vacant'],
            datasets: [{
                data: [
                    document.getElementById('occupiedCount').value,
                    document.getElementById('vacantCount').value
                ],
                backgroundColor: ['#28a745', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Monthly Charges Chart
    const chargesCtx = document.getElementById('chargesChart').getContext('2d');
    fetch('/api/v1/units/monthly-charges')
        .then(response => response.json())
        .then(data => {
            new Chart(chargesCtx, {
                type: 'bar',
                data: {
                    labels: data.months,
                    datasets: [{
                        label: 'Total Charges',
                        data: data.amounts,
                        backgroundColor: '#007bff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        });
}

// Utility Functions
function showToast(title, message, type) {
    Toastify({
        text: message,
        duration: 3000,
        gravity: 'top',
        position: 'right',
        backgroundColor: type === 'success' ? '#28a745' : '#dc3545'
    }).showToast();
}

async function confirmDialog(message) {
    return await Swal.fire({
        title: 'Confirm Action',
        text: message,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, proceed!'
    }).then((result) => result.isConfirmed);
}

// Export Functions
function exportUnitData(format) {
    const filters = {
        building_id: $('#buildingFilter').val(),
        floor_id: $('#floorFilter').val(),
        status: $('#statusFilter').val()
    };

    window.location.href = `/api/v1/units/export/${format}?${new URLSearchParams(filters)}`;
}
</script>
{% endblock %}